AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Audio TTS Serverless API

Globals:
  Function:
    Timeout: 60
    Runtime: python3.11
    MemorySize: 512
  Api:
    BinaryMediaTypes:
      - audio/mpeg
      - application/octet-stream

Resources:
  # =========================
  # S3 BUCKET
  # =========================
  AudioBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: my-audio-bucket

  # =========================
  # DYNAMODB TABLE
  # =========================
  AudioTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: AudioFiles
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH

  # =========================
  # GENERATE AUDIO LAMBDA
  # =========================
  GenerateAudioFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lambdas/
      Handler: generate_voice_lambda.main
      Environment:
        Variables:
          FASTAPI_TTS_URL: "http://fastapi-tts:8002"
          AUDIO_BUCKET: "my-audio-bucket"
          MINIO_ENDPOINT: "http://minio:9000"
          MINIO_ACCESS_KEY: "minioadmin"
          MINIO_SECRET_KEY: "minioadmin"
          DYNAMODB_ENDPOINT: "http://dynamodb:8000"
          TABLE_NAME: AudioFiles
      Policies:
        - S3CrudPolicy:
            BucketName: "my-audio-bucket"
        - DynamoDBCrudPolicy:
            TableName: !Ref AudioTable
      Events:
        GenerateAPI:
          Type: Api
          Properties:
            Path: /generate
            Method: post

  # =========================
  # LIST FILES LAMBDA
  # =========================
  ListFilesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lambdas/
      Handler: list_files_lambda.main
      Environment:
        Variables:
          DYNAMODB_ENDPOINT: "http://dynamodb:8000"
          TABLE_NAME: AudioFiles
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref AudioTable
      Events:
        ListAPI:
          Type: Api
          Properties:
            Path: /files
            Method: get

  # =========================
  # DOWNLOAD AUDIO LAMBDA
  # =========================
  DownloadAudioFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lambdas/
      Handler: download_audio_lambda.lambda_handler
      Environment:
        Variables:
          AUDIO_BUCKET: "my-audio-bucket"
          MINIO_ENDPOINT: "http://minio:9000"
          MINIO_ACCESS_KEY: "minioadmin"
          MINIO_SECRET_KEY: "minioadmin"
      Policies:
        - S3ReadPolicy:
            BucketName: "my-audio-bucket"
      Events:
        DownloadAPI:
          Type: Api
          Properties:
            Path: /download/{file_id}
            Method: get

  # =========================
  # STATS ACTIVITY LAMBDA
  # =========================
  StatsActivityFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lambdas/
      Handler: stats_activity_lambda.main
      Environment:
        Variables:
          DYNAMODB_ENDPOINT: "http://dynamodb:8000"
          TABLE_NAME: AudioFiles
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref AudioTable
      Events:
        StatsActivityAPI:
          Type: Api
          Properties:
            Path: /stats/activity
            Method: get

  # =========================
  # STATS LANGUAGES LAMBDA
  # =========================
  StatsLanguagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lambdas/
      Handler: stats_languages_lambda.main
      Environment:
        Variables:
          DYNAMODB_ENDPOINT: "http://dynamodb:8000"
          TABLE_NAME: AudioFiles
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref AudioTable
      Events:
        StatsLanguagesAPI:
          Type: Api
          Properties:
            Path: /stats/languages
            Method: get

  # =========================
  # STATS VOICES LAMBDA
  # =========================
  StatsVoicesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/lambdas/
      Handler: stats_voices_lambda.main
      Environment:
        Variables:
          DYNAMODB_ENDPOINT: "http://dynamodb:8000"
          TABLE_NAME: AudioFiles
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref AudioTable
      Events:
        StatsVoicesAPI:
          Type: Api
          Properties:
            Path: /stats/voices
            Method: get

Outputs:
  ApiURL:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"